{% extends "base.html" %}

{% block title %}Sessions Admin{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Gestion des sessions (Refresh Tokens)</h2>

    <!-- Tableau des sessions -->
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>User ID</th>
                <th>Token</th>
                <th>Date de création</th>
                <th>Révoqué</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="sessionsTable">
            <!-- Les lignes seront injectées par JS -->
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadSessions() {
    try {
        const response = await fetch("/admin/sessions");
        if (!response.ok) {
            throw new Error("Impossible de charger les sessions");
        }
        const sessions = await response.json();
        const table = document.getElementById("sessionsTable");
        table.innerHTML = "";

        sessions.forEach(s => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${s.id}</td>
                <td>${s.user_id}</td>
                <td style="max-width:250px; overflow:hidden; text-overflow:ellipsis;">${s.token}</td>
                <td>${new Date(s.created_at).toLocaleString()}</td>
                <td>${s.revoked ? "✅ Oui" : "❌ Non"}</td>
                <td>
                    ${s.revoked 
                        ? "<span class='text-muted'>Déjà révoqué</span>" 
                        : `<button class="btn btn-danger btn-sm" onclick="revokeSession(${s.id})">Révoquer</button>`
                    }
                </td>
            `;
            table.appendChild(row);
        });
    } catch (err) {
        console.error(err);
        showCriticalAlert("Erreur lors du chargement des sessions ❌");
    }
}

async function revokeSession(sessionId) {
    try {
        const response = await fetch(`/admin/sessions/revoke/${sessionId}`, { method: "POST" });
        if (response.ok) {
            showAlert(`Session ${sessionId} révoquée ✅`, "success");
            loadSessions(); // recharger la liste
        } else {
            showCriticalAlert("Impossible de révoquer la session ❌");
        }
    } catch (err) {
        console.error(err);
        showCriticalAlert("Erreur lors de la révocation ❌");
    }
}

// Charger les sessions au démarrage
loadSessions();
</script>
{% endblock %}
