{% extends "base.html" %}

{% block title %}Gestion des utilisateurs{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Gestion des utilisateurs</h2>

    <!-- Filtres -->
    <form id="filtersForm" class="row g-3 mb-3">
        <div class="col-md-3">
            <label for="roleFilter" class="form-label">Rôle</label>
            <select id="roleFilter" class="form-select">
                <option value="">Tous</option>
                <option value="admin">Admin</option>
                <option value="researcher">Researcher</option>
                <option value="visitor">Visitor</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="statusFilter" class="form-label">Statut</label>
            <select id="statusFilter" class="form-select">
                <option value="">Tous</option>
                <option value="active">Actif</option>
                <option value="inactive">Inactif</option>
            </select>
        </div>
        <div class="col-md-3 align-self-end">
            <button type="button" class="btn btn-primary" onclick="loadUsers()">Filtrer</button>
        </div>
        <div class="col-md-3 align-self-end text-end">
            <button type="button" class="btn btn-success" onclick="exportCSV()">Exporter CSV</button>
        </div>
    </form>

    <!-- Tableau des utilisateurs -->
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Rôle</th>
                <th>Statut</th>
            </tr>
        </thead>
        <tbody id="usersTable">
            <!-- Les lignes seront injectées par JS -->
        </tbody>
    </table>

    <!-- Pagination -->
    <nav>
        <ul class="pagination" id="pagination">
            <!-- Pagination dynamique -->
        </ul>
    </nav>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
const perPage = 10;

async function loadUsers(page = 1) {
    currentPage = page;
    const role = document.getElementById("roleFilter").value;
    const status = document.getElementById("statusFilter").value;

    try {
        const response = await fetch(`/admin/users?role=${role}&status=${status}&page=${page}&per_page=${perPage}`);
        if (!response.ok) throw new Error("Erreur lors du chargement des utilisateurs");

        const data = await response.json();
        const table = document.getElementById("usersTable");
        table.innerHTML = "";

        data.users.forEach(u => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${u.id}</td>
                <td>${u.email}</td>
                <td>${u.role}</td>
                <td>${u.status}</td>
            `;
            table.appendChild(row);
        });

        // Pagination
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";
        const totalPages = Math.ceil(data.total / perPage);

        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement("li");
            li.className = "page-item" + (i === page ? " active" : "");
            li.innerHTML = `<a class="page-link" href="#" onclick="loadUsers(${i})">${i}</a>`;
            pagination.appendChild(li);
        }

    } catch (err) {
        console.error(err);
        showCriticalAlert("Erreur lors du chargement des utilisateurs ❌");
    }
}

function exportCSV() {
    const role = document.getElementById("roleFilter").value;
    const status = document.getElementById("statusFilter").value;
    window.location.href = `/admin/users/export?role=${role}&status=${status}`;
}

// Charger les utilisateurs au démarrage
loadUsers();
</script>
{% endblock %}
