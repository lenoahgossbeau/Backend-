{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">ðŸ“Š Journal des audits</h2>

    <!-- Formulaire de filtre -->
    <form method="get" action="/audits" class="mb-3">
        <div class="row g-3">
            <!-- Filtre par rÃ´le -->
            <div class="col-md-3">
                <select name="role" class="form-select">
                    <option value="">-- Filtrer par rÃ´le --</option>
                    <option value="admin">Admin</option>
                    <option value="researcher">Researcher</option>
                    <option value="visitor">Visitor</option>
                </select>
            </div>

            <!-- Filtre par date dÃ©but -->
            <div class="col-md-3">
                <input type="date" name="start_date" class="form-control" placeholder="Date dÃ©but">
            </div>

            <!-- Filtre par date fin -->
            <div class="col-md-3">
                <input type="date" name="end_date" class="form-control" placeholder="Date fin">
            </div>

            <!-- Bouton de filtre -->
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">Filtrer</button>
            </div>
        </div>
    </form>

    <!-- Bouton Export CSV -->
    <div class="mb-3">
        <button id="exportBtn" class="btn btn-success">
            ðŸ“¥ Exporter en CSV
        </button>
    </div>

    <!-- Tableau des audits -->
    <table class="table table-striped table-bordered mt-3">
        <thead class="table-dark">
            <tr>
                <th>Date</th>
                <th>Utilisateur (ID)</th>
                <th>RÃ´le</th>
                <th>Action</th>
                <th>IP</th>
            </tr>
        </thead>
        <tbody>
            {% for audit in audits %}
            <tr>
                <td>{{ audit.date.strftime("%Y-%m-%d %H:%M:%S") }}</td>
                <td>{{ audit.user_id }}</td>
                <td>{{ audit.user_role }}</td>
                <td>{{ audit.action_description }}</td>
                <td>{{ audit.ip if audit.ip else "N/A" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if audits|length == 0 %}
    <div class="alert alert-info mt-3">
        Aucun log dâ€™audit enregistrÃ© pour le moment.
    </div>
    {% endif %}

    <!-- Pagination -->
    <nav aria-label="Pagination des audits" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page > 1 %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page - 1 }}{% if role %}&role={{ role }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">
                    PrÃ©cÃ©dent
                </a>
            </li>
            {% endif %}

            <li class="page-item active">
                <span class="page-link">Page {{ page }}</span>
            </li>

            {% if has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page + 1 }}{% if role %}&role={{ role }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">
                    Suivant
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
</div>

<!-- Script pour export CSV avec JWT -->
<script>
document.getElementById("exportBtn").addEventListener("click", async () => {
    const token = localStorage.getItem("access_token"); // rÃ©cupÃ¨re le token JWT
    if (!token) {
        alert("Vous devez Ãªtre connectÃ© pour exporter les audits.");
        return;
    }

    // RÃ©cupÃ¨re les filtres actuels de l'URL
    const params = new URLSearchParams(window.location.search);
    const role = params.get("role") || "";
    const start_date = params.get("start_date") || "";
    const end_date = params.get("end_date") || "";

    const query = new URLSearchParams({ role, start_date, end_date }).toString();
    const url = `/audits/export?${query}`;

    const response = await fetch(url, {
        headers: {
            "Authorization": `Bearer ${token}`
        }
    });

    if (!response.ok) {
        alert("Erreur lors de l'export : " + response.statusText);
        return;
    }

    const blob = await response.blob();
    const link = document.createElement("a");
    link.href = window.URL.createObjectURL(blob);
    link.download = "audits.csv";
    link.click();
});
</script>
{% endblock %}
